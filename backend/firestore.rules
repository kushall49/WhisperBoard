rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated (for future use)
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if data is valid
    function isValidDoubt(data) {
      return data.keys().hasAll(['subject', 'courseCode', 'teacher', 'question', 'status', 'createdAt'])
        && data.subject is string && data.subject.size() > 0
        && data.courseCode is string && data.courseCode.size() > 0
        && data.teacher is string && data.teacher.size() > 0
        && data.question is string && data.question.size() >= 10
        && data.status in ['Pending', 'Answered'];
    }
    
    // Rules for 'doubts' collection
    match /doubts/{doubtId} {
      
      // Allow anyone to read doubts (anonymous access)
      // In production, you may want to restrict this based on authentication
      allow read: if true;
      
      // Allow anyone to create doubts (anonymous submission)
      allow create: if isValidDoubt(request.resource.data)
        && request.resource.data.status == 'Pending'
        && request.resource.data.answer == null
        && request.resource.data.answeredAt == null;
      
      // Allow updates only for answering doubts
      // In production, add teacher authentication check
      allow update: if isValidDoubt(request.resource.data)
        && request.resource.data.answer is string
        && request.resource.data.answer.size() >= 10
        && request.resource.data.status == 'Answered'
        && request.resource.data.answeredAt is timestamp
        // Ensure core fields aren't modified
        && request.resource.data.subject == resource.data.subject
        && request.resource.data.courseCode == resource.data.courseCode
        && request.resource.data.teacher == resource.data.teacher
        && request.resource.data.question == resource.data.question
        && request.resource.data.createdAt == resource.data.createdAt;
      
      // Prevent deletion (keep all doubts for record)
      // In production, you may allow teacher/admin to delete
      allow delete: if false;
    }
    
    // Deny access to all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
